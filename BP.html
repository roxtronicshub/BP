<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareTech | Medical Device Service Portal</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lexend:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .brand-font { font-family: 'Lexend', sans-serif; }
        .brand-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .input-focus:focus { border-color: #3b82f6; ring: 2px; ring-color: #bfdbfe; outline: none; }
        .modal-overlay { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .table-container::-webkit-scrollbar { height: 6px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .row-accepted { transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: translateX(30px); pointer-events: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="brand-gradient text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-2 rounded-xl shadow-lg">
                    <svg class="w-8 h-8 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12h-4l-3 9L9 3l-3 9H2" /></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-tight uppercase brand-font">CareTech Repair Services</h1>
                    <p class="text-xs font-medium opacity-80 uppercase tracking-widest flex items-center"><span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>Professional Medical Support</p>
                </div>
            </div>
            <div id="hubStatusInfo" class="hidden mt-4 md:mt-0 text-xs bg-white/20 px-4 py-2 rounded-full border border-white/30 backdrop-blur-md">
                Hub Active: <span id="activeHubName" class="font-bold"></span> | <button onclick="logoutHub()" class="underline ml-1 hover:text-red-200 font-bold uppercase">Logout</button>
            </div>
        </div>
    </nav>

    <main class="max-w-[1400px] mx-auto px-4 py-10">
        <div class="flex p-1.5 bg-slate-200 rounded-2xl mb-10 max-w-lg mx-auto shadow-inner border border-slate-300">
            <button onclick="showTab('track')" id="btn-track" class="flex-1 py-3 px-4 rounded-xl text-xs font-black transition-all duration-200 bg-white text-blue-700 shadow-md">TRACK STATUS</button>
            <button onclick="showTab('register')" id="btn-register" class="flex-1 py-3 px-4 rounded-xl text-xs font-black transition-all duration-200 text-slate-600">NEW REPAIR</button>
            <button onclick="showTab('login')" id="btn-login" class="flex-1 py-3 px-4 rounded-xl text-xs font-black transition-all duration-200 text-slate-600">HUB LOGIN</button>
        </div>

        <!-- 1. TRACKING -->
        <div id="tab-track" class="tab-content active">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 uppercase tracking-tight">Service Status Dashboard</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-10 max-w-3xl">
                    <input type="text" id="searchId" placeholder="Enter ID (BP/2026/...) or Mobile" class="flex-1 p-4 border border-slate-300 rounded-2xl input-focus font-semibold text-slate-700 shadow-inner">
                    <button onclick="fetchStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-2xl font-bold shadow-lg brand-font uppercase tracking-wide transform active:scale-95 transition-all">Search Records</button>
                </div>
                <div id="searchResult" class="hidden mt-10">
                    <p id="resultCount" class="mb-4 text-[11px] font-black text-blue-600 uppercase bg-blue-50 inline-block px-3 py-1 rounded-md tracking-widest border border-blue-100"></p>
                    <div class="overflow-x-auto table-container rounded-2xl border border-slate-200 shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200 text-slate-500">
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest text-nowrap">Submit Date</th>
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest">ID</th>
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest">Customer</th>
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest text-nowrap">Device Info</th>
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest text-center whitespace-nowrap">Live Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. REGISTRATION -->
        <div id="tab-register" class="tab-content">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 md:p-12 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-8 uppercase tracking-tight">Register Medical Device</h2>
                <form id="regForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Device Category</label><select id="deviceCategory" onchange="handleCategoryChange()" class="w-full p-4 border border-slate-300 rounded-2xl input-focus font-bold text-slate-700 bg-slate-50 shadow-sm cursor-pointer"><option value="BP" selected>BP Monitor</option><option value="NB">Nebulizer</option><option value="OX">Oximeter</option><option value="OTH">Other Medical Device</option></select></div>
                    
                    <div class="space-y-2 relative">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Assign Hub</label>
                        <select id="collectionHub" onchange="handleHubChange()" required class="w-full p-4 border border-slate-300 rounded-2xl input-focus font-bold text-blue-700 bg-slate-50 shadow-sm cursor-pointer">
                            <option value="" disabled selected>Loading hubs...</option>
                        </select>
                        
                        <div id="selectedHubAddress" class="hidden mt-3 p-4 bg-indigo-50 border border-indigo-100 rounded-2xl shadow-inner text-indigo-800 items-start gap-3 transition-all duration-300">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <div>
                                <span class="uppercase tracking-widest text-indigo-400 block mb-1 text-[9px] font-black">Drop-off Location</span>
                                <span id="hubAddressText" class="text-sm font-semibold leading-tight block"></span>
                            </div>
                        </div>
                    </div>

                    <div id="otherDeviceDiv" class="hidden md:col-span-2 space-y-2 animate-fadeIn"><label class="text-[10px] font-black text-blue-600 uppercase">Specify Machine Name</label><input type="text" id="otherDeviceName" placeholder="e.g. ECG Machine" class="w-full p-4 bg-blue-50 border-2 border-blue-200 rounded-2xl input-focus font-bold"></div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Ticket ID</label><input type="text" id="repairId" readonly class="w-full p-4 bg-slate-100 border rounded-2xl font-mono font-bold text-slate-500"></div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Customer Name</label><input type="text" id="custName" required placeholder="Full Name" class="w-full p-4 border border-slate-200 rounded-2xl input-focus"></div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Mobile Number</label><input type="number" id="custMobile" required placeholder="10 Digits" oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10);" class="w-full p-4 border border-slate-200 rounded-2xl input-focus"></div>
                    <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Brand/Model Info</label><input type="text" id="machineModel" required placeholder="e.g. Omron M2" class="w-full p-4 border border-slate-200 rounded-2xl input-focus"></div>
                    <div class="md:col-span-2 space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Fault Description</label><textarea id="problem" rows="3" required placeholder="Describe issue details..." class="w-full p-4 border border-slate-200 rounded-2xl input-focus"></textarea></div>
                    <button type="submit" class="md:col-span-2 brand-gradient text-white py-5 rounded-2xl font-black shadow-xl brand-font uppercase tracking-widest transform active:scale-95 transition-all">Confirm Registration</button>
                </form>
            </div>
        </div>

        <!-- 3. HUB LOGIN & DASHBOARD -->
        <div id="tab-login" class="tab-content">
            <div id="loginFormDiv" class="max-w-md mx-auto bg-white rounded-3xl shadow-sm border border-slate-200 p-10 mt-10">
                <div class="text-center mb-8"><h2 class="text-2xl font-bold text-slate-800 uppercase tracking-tight">Hub Portal Login</h2></div>
                <div class="space-y-5">
                    <input type="text" id="hubUsername" placeholder="Username" class="w-full p-4 border border-slate-200 rounded-2xl input-focus font-medium">
                    <input type="password" id="hubPassword" placeholder="Password" class="w-full p-4 border border-slate-200 rounded-2xl input-focus font-medium">
                    <button onclick="loginToHub()" id="loginBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition shadow-xl brand-font uppercase tracking-widest">Open Dashboard</button>
                </div>
            </div>

            <div id="hubDashboard" class="hidden animate-fadeIn space-y-8">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 text-nowrap">
                    <div><h2 class="text-2xl font-extrabold text-slate-800 uppercase tracking-tight">Hub Control Center</h2><p id="hubAddressDisplay" class="text-blue-600 text-[10px] font-black uppercase tracking-[0.1em] mt-1"></p></div>
                    <button onclick="refreshHubData()" class="bg-slate-50 hover:bg-slate-100 p-3 rounded-xl border border-slate-200 shadow-sm group"><svg class="w-6 h-6 text-slate-600 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"><h3 class="text-xs font-black text-slate-500 uppercase tracking-widest flex items-center">New Machine Requests</h3><span id="pendingCountBadge" class="bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter">0 PENDING</span></div>
                    <div class="overflow-x-auto table-container"><table class="w-full text-left border-collapse"><thead><tr class="bg-white border-b border-slate-200 text-slate-400"><th class="p-5 text-[10px] font-black uppercase tracking-widest">ID</th><th class="p-5 text-[10px] font-black uppercase tracking-widest">Customer</th><th class="p-5 text-[10px] font-black uppercase tracking-widest text-nowrap">Machine Details</th><th class="p-5 text-[10px] font-black uppercase tracking-widest text-center">Action</th></tr></thead><tbody id="hubTableBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 flex items-center justify-center z-[200] hidden modal-overlay p-4"><div class="bg-white rounded-[2.5rem] shadow-2xl max-w-md w-full overflow-hidden border border-slate-100"><div class="brand-gradient p-10 text-center text-white relative"><h3 class="text-2xl font-black uppercase brand-font">Registration Success</h3><p class="text-blue-100 text-xs font-bold uppercase tracking-[0.2em] opacity-80 mt-2">Saved to Cloud</p></div><div class="p-10 text-center"><p class="text-slate-400 mb-2 font-bold text-[10px] uppercase">Service Ticket ID</p><div class="bg-slate-50 border-2 border-dashed border-slate-200 p-6 rounded-3xl mb-8 shadow-inner"><span id="modalIdDisplay" class="text-3xl font-black text-slate-800 tracking-[0.15em] font-mono"></span></div><button onclick="closeModal()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest brand-font transform active:scale-95">Close</button></div></div></div>
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 hidden bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl text-[10px] font-black uppercase tracking-widest z-[300] border border-white/10"></div>

    <script>
        // CRITICAL: Replace with your LATEST DEPLOYED URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxEAqcoW12GHjEDiFeE4vQTuA1YuXv0g5tQtchR5lqVkn8GMzmmHkA2G7Cg224C8pKz/exec";
        
        let activeHub = null;
        let locallyAcceptedIds = [];
        let hubDataList = []; 

        function generateUniqueID() { 
            const prefix = document.getElementById('deviceCategory').value; 
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const randomCode = Math.floor(Math.random() * 900) + 100; // 3 digit random code
            
            // Format: Prefix/YYYY/MMDD/RandomCode (e.g. BP/2026/0226/452)
            const newID = `${prefix}/${year}/${month}${day}/${randomCode}`; 
            
            document.getElementById('repairId').value = newID; 
            return newID; 
        }

        function handleCategoryChange() { const isOther = document.getElementById('deviceCategory').value === 'OTH'; document.getElementById('otherDeviceDiv').classList.toggle('hidden', !isOther); document.getElementById('otherDeviceName').required = isOther; generateUniqueID(); }

        async function loadHubs() {
            const hubSelect = document.getElementById('collectionHub');
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`${SCRIPT_URL}?action=getHubs&t=${timestamp}`);
                const responseData = await response.json();
                
                let optionsHtml = '<option value="" disabled selected>Select Hub...</option>';
                
                if(responseData && responseData.length > 0) {
                    if (typeof responseData[0] === 'string') {
                        optionsHtml += responseData.map(h => `<option value="${h}">${h}</option>`).join('');
                    } else {
                        hubDataList = responseData; 
                        optionsHtml += responseData.map(h => `<option value="${h.name}">${h.name}</option>`).join('');
                    }
                } else {
                    optionsHtml += '<option value="Direct Center">Direct Center</option>';
                }
                hubSelect.innerHTML = optionsHtml;
            } catch (e) { 
                hubSelect.innerHTML = '<option value="Error">Network Error</option>'; 
            }
        }

        function handleHubChange() {
            const selectedHub = document.getElementById('collectionHub').value;
            const addressElement = document.getElementById('selectedHubAddress');
            const textElement = document.getElementById('hubAddressText');
            
            const hub = hubDataList.find(h => h.name === selectedHub);
            
            if (hub && hub.address) {
                textElement.innerText = hub.address;
                addressElement.classList.remove('hidden');
                addressElement.classList.add('flex');
            } else {
                addressElement.classList.add('hidden');
                addressElement.classList.remove('flex');
                textElement.innerText = '';
            }
        }

        async function fetchStatus() {
            const searchVal = document.getElementById('searchId').value.trim();
            if(!searchVal) return showToast("Zaroori details enter karein");
            const resultDiv = document.getElementById('searchResult');
            const tableBody = document.getElementById('resultTableBody');
            showToast("Searching Database...");
            try {
                const response = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(searchVal)}&mobile=${encodeURIComponent(searchVal)}`);
                const data = await response.json();
                if(data.result === 'success') {
                    const acceptedRecords = data.data.filter(item => item.status && item.status.trim() !== '' && item.status.trim().toLowerCase() !== 'pending acceptance');
                    if (acceptedRecords.length > 0) {
                        resultDiv.classList.remove('hidden'); tableBody.innerHTML = '';
                        document.getElementById('resultCount').innerText = `${acceptedRecords.length} Record(s) Found`;
                        acceptedRecords.forEach(item => {
                            let displayType = item.id.startsWith('OTH') ? (item.model.match(/^\[(.*?)\]/)?.[1] || "Other Device") : (item.id.startsWith('BP') ? "BP Monitor" : item.id.startsWith('NB') ? "Nebulizer" : "Oximeter");
                            let cleanModel = item.model.replace(/^\[.*?\]\s*/, '');
                            
                            // Updated Status UI Logic to handle Rejected status
                            let statusUI = "";
                            let statusText = item.status;
                            if(item.status.toLowerCase().includes('accepted')) {
                                statusUI = "bg-green-100 text-green-800 border-green-200 font-bold uppercase";
                            } else if(item.status.toLowerCase().includes('reject')) {
                                statusUI = "bg-red-100 text-red-800 border-red-200 font-bold uppercase";
                            } else {
                                statusUI = "bg-indigo-100 text-indigo-700 border-indigo-200 font-bold uppercase";
                            }
                            
                            tableBody.innerHTML += `<tr class="border-b hover:bg-slate-50 transition-colors"><td class="p-4 text-xs font-medium text-slate-500 whitespace-nowrap text-nowrap">${item.date}</td><td class="p-4 font-mono font-bold text-blue-600 text-sm">${item.id}</td><td class="p-4 font-bold text-slate-800 text-sm text-nowrap">${item.name}</td><td class="p-4"><span class="text-[9px] font-black uppercase text-indigo-600 block leading-none mb-1 tracking-widest text-nowrap">${displayType}</span><span class="text-xs font-semibold text-slate-600 text-nowrap">${cleanModel}</span></td><td class="p-4 text-center"><span class="px-3 py-2 rounded-xl text-[9px] font-black uppercase border shadow-sm ${statusUI} flex items-center justify-center whitespace-nowrap">${statusText}</span></td></tr>`;
                        });
                    } else { resultDiv.classList.add('hidden'); showToast("Verification Pending..."); }
                } else { resultDiv.classList.add('hidden'); showToast("Record nahi mila!"); }
            } catch (e) { showToast("Network Error!"); }
        }

        async function loginToHub() {
            const user = document.getElementById('hubUsername').value.trim();
            const pass = document.getElementById('hubPassword').value.trim();
            const btn = document.getElementById('loginBtn');
            if(!user || !pass) return showToast("Credentials enter karein");
            btn.disabled = true; btn.innerText = "Verifying...";
            try {
                const response = await fetch(`${SCRIPT_URL}?action=hubLogin&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`);
                const res = await response.json();
                if(res.result === 'success') {
                    activeHub = res.hubName;
                    document.getElementById('loginFormDiv').classList.add('hidden');
                    document.getElementById('hubDashboard').classList.remove('hidden');
                    document.getElementById('hubStatusInfo').classList.remove('hidden');
                    document.getElementById('activeHubName').innerText = activeHub;
                    document.getElementById('hubAddressDisplay').innerText = res.hubAddress;
                    refreshHubData();
                } else { showToast("Galt ID ya Password!"); }
            } catch (e) { showToast("Fetch Error!"); } finally { btn.disabled = false; btn.innerText = "Open Dashboard"; }
        }

        async function refreshHubData() {
            if(!activeHub) return;
            const tableBody = document.getElementById('hubTableBody');
            tableBody.innerHTML = `<tr><td colspan="4" class="p-16 text-center text-slate-400 font-bold animate-pulse text-[10px] uppercase tracking-widest">Syncing Records...</td></tr>`;
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getHubData&hubName=${encodeURIComponent(activeHub)}`);
                const data = await response.json();
                if(data.result === 'success') {
                    const pendingList = data.data.filter(m => (!m.status || m.status.trim() === '' || m.status.toLowerCase() === 'pending acceptance') && !locallyAcceptedIds.includes(m.id));
                    document.getElementById('pendingCountBadge').innerText = `${pendingList.length} PENDING`;
                    if(pendingList.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" class="p-20 text-center text-slate-300 font-black uppercase text-xs tracking-widest">All processed!</td></tr>`; return; }
                    tableBody.innerHTML = pendingList.map(item => `
                        <tr id="row-${item.id}" class="border-b hover:bg-slate-50 transition-all duration-300">
                            <td class="p-4 font-mono font-bold text-blue-600 text-sm">${item.id}</td>
                            <td class="p-4 font-bold text-slate-800 text-sm text-nowrap">${item.name}</td>
                            <td class="p-4 text-xs font-medium text-slate-500">${item.model}</td>
                            <td class="p-4">
                                <div class="flex gap-2 justify-center">
                                    <button id="btn-accept-${item.id}" onclick="updateMachineStatus('${item.id}', 'Accepted for repair')" class="bg-green-600 text-white px-3 py-2 rounded-xl text-[9px] font-black uppercase shadow-sm hover:bg-green-700 active:scale-95 transition-all whitespace-nowrap">Accept</button>
                                    <button id="btn-reject-${item.id}" onclick="updateMachineStatus('${item.id}', 'Rejected')" class="bg-red-500 text-white px-3 py-2 rounded-xl text-[9px] font-black uppercase shadow-sm hover:bg-red-600 active:scale-95 transition-all whitespace-nowrap">Reject</button>
                                </div>
                            </td>
                        </tr>`).join('');
                }
            } catch (e) { showToast("Refresh failed"); }
        }

        async function updateMachineStatus(id, newStatus) {
            const btnAccept = document.getElementById(`btn-accept-${id}`);
            const btnReject = document.getElementById(`btn-reject-${id}`);
            const row = document.getElementById(`row-${id}`);
            
            if(btnAccept) { btnAccept.disabled = true; btnAccept.innerText = "..."; }
            if(btnReject) { btnReject.disabled = true; btnReject.innerText = "..."; }
            
            showToast("Updating Sheet...");
            try {
                locallyAcceptedIds.push(id); 
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'updateStatus', id: id, newStatus: newStatus })
                });
                
                if (newStatus === 'Rejected') {
                    showToast("DEVICE REJECTED!");
                } else {
                    showToast("DEVICE ACCEPTED SUCCESSFULLY!");
                }
                
                if(row) {
                    row.classList.add('row-accepted');
                    setTimeout(() => {
                        row.remove();
                        if (document.getElementById('hubTableBody').children.length === 0) refreshHubData();
                        else document.getElementById('pendingCountBadge').innerText = `${parseInt(document.getElementById('pendingCountBadge').innerText) - 1} PENDING`;
                    }, 600);
                }
            } catch (e) { 
                showToast("Server Error!"); 
                locallyAcceptedIds = locallyAcceptedIds.filter(lid => lid !== id); 
                if(btnAccept) { btnAccept.disabled = false; btnAccept.innerText = "Accept"; }
                if(btnReject) { btnReject.disabled = false; btnReject.innerText = "Reject"; }
            }
        }

        function logoutHub() { activeHub = null; locallyAcceptedIds = []; document.getElementById('hubDashboard').classList.add('hidden'); document.getElementById('hubStatusInfo').classList.add('hidden'); document.getElementById('loginFormDiv').classList.remove('hidden'); showTab('login'); }
        window.onload = () => { generateUniqueID(); loadHubs(); };
        function showTab(tab) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById('tab-' + tab).classList.add('active'); ['track', 'register', 'login'].forEach(t => { const btn = document.getElementById('btn-' + t); if(btn) btn.className = (t === tab) ? "flex-1 py-3 px-4 rounded-xl text-xs font-black transition-all duration-200 bg-white text-blue-700 shadow-md" : "flex-1 py-3 px-4 rounded-xl text-xs font-black transition-all duration-200 text-slate-600"; }); if(tab === 'login' && activeHub) refreshHubData(); }
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3500); }
        function showSuccessModal(id) { document.getElementById('modalIdDisplay').innerText = id; document.getElementById('successModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('successModal').classList.add('hidden'); }

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerHTML = `SAVING...`;
            const payload = { action: 'register', id: document.getElementById('repairId').value, name: document.getElementById('custName').value, mobile: document.getElementById('custMobile').value, model: document.getElementById('deviceCategory').value === 'OTH' ? `[${document.getElementById('otherDeviceName').value}] ${document.getElementById('machineModel').value}` : document.getElementById('machineModel').value, problem: document.getElementById('problem').value, hub: document.getElementById('collectionHub').value };
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                showSuccessModal(payload.id); e.target.reset(); handleCategoryChange();
                document.getElementById('selectedHubAddress').classList.add('hidden');
                document.getElementById('selectedHubAddress').classList.remove('flex');
            } catch (e) { showToast("Failed to save!"); } finally { btn.disabled = false; btn.innerText = "Register Entry"; }
        };
    </script>
</body>
</html>
